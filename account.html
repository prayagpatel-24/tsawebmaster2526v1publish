<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account - Ripple</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&family=Courgette&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="account.css">
</head>
<body>
  <div class="page">
    <div id="header-placeholder"></div>
    <main class="account-main">
      <section class="account-card">
        <div class="account-card-grid">
          <div class="account-info">
            <h2>Your Account</h2>
            <form id="accountForm" class="account-form">
              <label class="field-label">Full Name</label>
              <input type="text" id="fullName" placeholder="Your full name" />
              <label class="field-label">Email</label>
              <input type="email" id="email" placeholder="you@example.com" />
              <div class="form-actions">
                <button type="submit" class="primary-btn">Save Changes</button>
                <button type="button" id="signOutBtn" class="secondary-btn">Sign Out</button>
              </div>
              <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--border-subtle);">
              <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">All new users start as <strong>Member</strong>. Use "Request Admin Role" to ask for promotion.</p>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                <div class="extra-actions">
                  <button type="button" id="sendResetEmail" class="secondary-btn">Send Password Reset Email</button>
                </div>
                <div>
                  <button type="button" id="requestAdminBtn" class="secondary-btn">Request Admin Role</button>
                </div>
              </div>
              <div id="accountMessage" class="account-message" role="status" aria-live="polite"></div>
            </form>
          </div>
          <aside class="profile-side">
            <div class="photo-wrapper">
              <img id="photoPreview" src="logo.png" alt="Profile photo" />
              <input type="file" id="photoInput" accept="image/*" />
              <button id="uploadPhotoBtn" class="secondary-btn">Upload Photo</button>
              <div class="upload-hint">Large uploads can take a minute on slower connections.</div>
            </div>
            <div class="account-meta">
              <div><strong>UID:</strong> <span id="userUid">—</span></div>
              <div><strong>Role:</strong> <span id="userRole">Member</span></div>
              <div><strong>Member since:</strong> <span id="memberSince">—</span></div>
            </div>
          </aside>
        </div>
      </section>
    </main>
  </div>
  <div id="reauthModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card">
      <h3>Verify Your Identity</h3>
      <p>Please enter your current password to proceed with sensitive changes.</p>
      <input type="password" id="reauthPassword" placeholder="Current password" />
      <div class="modal-actions">
        <button id="reauthCancel" class="secondary-btn">Cancel</button>
        <button id="reauthConfirm" class="primary-btn">Confirm</button>
      </div>
      <div id="reauthMessage" class="account-message"></div>
    </div>
  </div>
  <div id="spamPopup" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card">
      <h3>✓ Email Sent</h3>
      <p>A password reset email has been sent. <strong>Please check your spam folder</strong> if you don't see it in your inbox within a few minutes.</p>
      <div class="modal-actions">
        <button id="spamPopupOk" class="primary-btn">Got it</button>
      </div>
    </div>
  </div>
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
  <footer class="footer">
    <div id="footer-placeholder"></div>
  </footer>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile, updateEmail, reauthenticateWithCredential, EmailAuthProvider, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBguT9BsQHwsAwAd3mbEmj3S5E7GtR_IBU",
      authDomain: "webmaster-v4-0.firebaseapp.com",
      projectId: "webmaster-v4-0",
      storageBucket: "webmaster-v4-0.firebasestorage.app",
      messagingSenderId: "413556961992",
      appId: "1:413556961992:web:899600895ecb68eb9debfd"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const accountForm = document.getElementById('accountForm');
    const accountMessage = document.getElementById('accountMessage');
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const userUidEl = document.getElementById('userUid');
    const memberSinceEl = document.getElementById('memberSince');
    const userRoleEl = document.getElementById('userRole');
    let currentUser = null;
    const guestId = localStorage.getItem('rippleVisitorId') || `visitor_${Math.random().toString(36).slice(2, 10)}_${Date.now().toString(36)}`;
    const guestProfileKey = 'rippleGuestProfile';
    localStorage.setItem('rippleVisitorId', guestId);
    function setGuestModeUI() {
      const guestProfile = JSON.parse(localStorage.getItem(guestProfileKey) || '{}');
      currentUser = null;
      document.getElementById('fullName').value = guestProfile.name || '';
      document.getElementById('email').value = guestProfile.email || '';
      userUidEl.textContent = guestId;
      memberSinceEl.textContent = 'Guest session';
      if (userRoleEl) userRoleEl.textContent = 'Guest';
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) signOutBtn.style.display = 'none';
      uploadPhotoBtn.disabled = true;
      photoInput.disabled = true;
      accountMessage.textContent = 'Guest mode enabled. Sign-in is optional.';
      accountMessage.style.color = '#2563eb';
    }
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setGuestModeUI();
        return;
      }
      currentUser = user;
      uploadPhotoBtn.disabled = false;
      photoInput.disabled = false;
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) signOutBtn.style.display = 'inline-flex';
      const avatar = document.querySelector('.avatar');
      if (avatar && user) {
        const initial = (user.email || '').charAt(0).toUpperCase();
        if (user.photoURL) {
          avatar.style.backgroundImage = `url('${user.photoURL}')`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.textContent = '';
        } else {
          avatar.style.backgroundImage = '';
          avatar.textContent = initial;
        }
        avatar.style.cursor = 'pointer';
        avatar.onclick = () => window.location.href = 'account.html';
      }
      document.getElementById('fullName').value = user.displayName || '';
      document.getElementById('email').value = user.email || '';
      userUidEl.textContent = user.uid;
      if (user.metadata && user.metadata.creationTime) {
        memberSinceEl.textContent = new Date(user.metadata.creationTime).toLocaleDateString();
      }
      if (user.photoURL) {
        photoPreview.src = user.photoURL;
      }
      try {
        const docRef = doc(db, 'users', user.uid);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          if (userRoleEl) {
            userRoleEl.textContent = data.role ? data.role : 'Member';
          }
          if (data.photoURL && !user.photoURL) {
            photoPreview.src = data.photoURL;
          }
        }
      } catch (err) {
        console.warn('Could not fetch user doc:', err);
      }
    });
    function showToast(message, type = 'info', timeout = 4000) {
      const container = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = `toast toast-${type}`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => el.classList.add('show'), 50);
      setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, timeout);
    }
    uploadPhotoBtn.addEventListener('click', async () => {
      if (!currentUser) {
        showToast('Sign-in optional, but photo upload needs an account', 'info');
        return;
      }
      const file = photoInput.files[0];
      if (!file) {
        accountMessage.textContent = 'Please choose a file first.';
        accountMessage.style.color = '#ef4444';
        return;
      }
      accountMessage.textContent = 'Uploading...';
      accountMessage.style.color = '#333';
      try {
        const storageReference = storageRef(storage, `profilePictures/${currentUser.uid}`);
        const uploadTask = uploadBytesResumable(storageReference, file);
        accountMessage.textContent = 'Uploading... 0%';
        accountMessage.style.color = '#333';
        const url = await new Promise((resolve, reject) => {
          uploadTask.on('state_changed', (snapshot) => {
            const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            accountMessage.textContent = `Uploading... ${percent}%`;
          }, reject, async () => {
            try {
              const downloadUrl = await getDownloadURL(uploadTask.snapshot.ref);
              resolve(downloadUrl);
            } catch (err) {
              reject(err);
            }
          });
        });
        await updateProfile(currentUser, { photoURL: url });
        await setDoc(doc(db, 'users', currentUser.uid), { photoURL: url }, { merge: true });
        photoPreview.src = url;
        accountMessage.textContent = 'Photo uploaded and profile updated.';
        accountMessage.style.color = '#2563eb';
        showToast('Profile photo updated', 'success');
      } catch (err) {
        console.error(err);
        accountMessage.textContent = 'Upload failed.';
        accountMessage.style.color = '#ef4444';
        showToast('Photo upload failed', 'error');
      }
    });
    let pendingChanges = null;
    accountForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        const guestName = document.getElementById('fullName').value.trim();
        const guestEmail = document.getElementById('email').value.trim();
        localStorage.setItem(guestProfileKey, JSON.stringify({ name: guestName, email: guestEmail }));
        accountMessage.textContent = 'Guest profile saved locally.';
        accountMessage.style.color = '#2563eb';
        showToast('Guest profile saved', 'success');
        return;
      }
      const newName = document.getElementById('fullName').value.trim();
      const newEmail = document.getElementById('email').value.trim();

      accountMessage.textContent = '';
      if (newEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
        accountMessage.textContent = 'Invalid email format.';
        accountMessage.style.color = '#ef4444';
        showToast('Invalid email format', 'error');
        return;
      }
      const needsReauth = (newEmail && newEmail !== currentUser.email);
      try {
        if (newName && newName !== currentUser.displayName) {
          await updateProfile(currentUser, { displayName: newName });
          await setDoc(doc(db, 'users', currentUser.uid), { name: newName }, { merge: true });
          showToast('Display name updated', 'success');
        }
      } catch (err) {
        console.error('Update failed', err);
        showToast('Failed to update profile', 'error');
      }
      if (!needsReauth) {
        showToast('Profile updated', 'success');
        accountMessage.textContent = 'Profile updated successfully.';
        accountMessage.style.color = '#2563eb';
        return;
      }
      pendingChanges = { newEmail };
      document.getElementById('reauthPassword').value = '';
      document.getElementById('reauthMessage').textContent = '';
      document.getElementById('reauthModal').classList.add('open');
    });
    document.getElementById('reauthCancel').addEventListener('click', () => {
      document.getElementById('reauthModal').classList.remove('open');
      pendingChanges = null;
      showToast('Operation cancelled', 'info');
    });
    document.getElementById('reauthConfirm').addEventListener('click', async () => {
      const pw = document.getElementById('reauthPassword').value;
      const msgEl = document.getElementById('reauthMessage');
      if (!pw) {
        msgEl.textContent = 'Please enter your current password.';
        msgEl.style.color = '#ef4444';
        return;
      }
      msgEl.textContent = 'Verifying...';
      msgEl.style.color = '#333';
      try {
        const cred = EmailAuthProvider.credential(currentUser.email, pw);
        await reauthenticateWithCredential(currentUser, cred);
        if (pendingChanges) {
          if (pendingChanges.newEmail && pendingChanges.newEmail !== currentUser.email) {
            await updateEmail(currentUser, pendingChanges.newEmail);
            await setDoc(doc(db, 'users', currentUser.uid), { email: pendingChanges.newEmail }, { merge: true });
            showToast('Email updated', 'success');
          }
          accountMessage.textContent = 'Profile updated successfully.';
          accountMessage.style.color = '#2563eb';
          pendingChanges = null;
        }
        document.getElementById('reauthModal').classList.remove('open');
      } catch (err) {
        console.error('Reauth failed', err);
        msgEl.textContent = 'Verification failed: ' + (err.message || '');
        msgEl.style.color = '#ef4444';
        showToast('Verification failed', 'error');
      }
    });
    document.getElementById('sendResetEmail').addEventListener('click', async () => {
      if (!currentUser || !currentUser.email) {
        showToast('Sign-in optional, but reset email needs an account', 'info');
        return;
      }
      try {
        await sendPasswordResetEmail(auth, currentUser.email);
        accountMessage.textContent = 'Password reset email sent to ' + currentUser.email;
        accountMessage.style.color = '#2563eb';
        document.getElementById('spamPopup').classList.add('open');
        showToast('Reset email sent', 'success');
      } catch (err) {
        console.error(err);
        accountMessage.textContent = 'Error sending reset email: ' + err.message;
        accountMessage.style.color = '#ef4444';
        showToast('Failed to send reset email', 'error');
      }
    });
    document.getElementById('requestAdminBtn').addEventListener('click', async () => {
      try {
        const typedEmail = (document.getElementById('email').value || '').trim();
        const actorId = currentUser ? currentUser.uid : guestId;
        const actorEmail = currentUser ? (currentUser.email || null) : (typedEmail || null);
        const payload = {
          requestedRole: 'admin',
          status: 'pending',
          createdBy: actorId,
          createdByEmail: actorEmail,
          actorType: currentUser ? 'user' : 'guest',
          createdAt: serverTimestamp()
        };
        const reqRef = await addDoc(collection(db, 'roleRequests'), payload);
        await addDoc(collection(db, 'notifications'), {
          type: 'roleRequest',
          itemType: 'roleRequest',
          itemId: reqRef.id,
          requestorId: actorId,
          title: 'Admin Role Request',
          message: `${actorEmail || 'A guest user'} has requested admin access.`,
          recipientsRole: ['admin','founder'],
          status: 'unread',
          createdBy: actorId,
          createdByEmail: actorEmail,
          createdAt: serverTimestamp()
        });
        showToast('Admin request submitted', 'success');
        accountMessage.textContent = 'Admin request submitted. An admin will review it.';
        accountMessage.style.color = '#2563eb';
      } catch (err) {
        console.error('Role request failed', err);
        showToast('Failed to request admin role', 'error');
      }
    });
    document.getElementById('spamPopupOk').addEventListener('click', () => {
      document.getElementById('spamPopup').classList.remove('open');
    });
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'main.html';
    });
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const footerPlaceholder = document.getElementById('footer-placeholder');
    if (footerPlaceholder) {
      fetch('footer.html')
        .then(response => response.text())
        .then(html => {
          footerPlaceholder.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading footer:', error);
        });
    }
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const headerPlaceholder = document.getElementById('header-placeholder');
  if (!headerPlaceholder) return;
  fetch('header.html')
    .then(response => response.text())
    .then(html => {
      headerPlaceholder.innerHTML = html;
      const navLinks = headerPlaceholder.querySelector('.nav-links');
      let accountLink = Array.from(navLinks.children).find(link => 
        link.textContent.includes('Account') || link.getAttribute('href') === 'account.html'
      );
      if (!accountLink) {
        accountLink = document.createElement('a');
        accountLink.href = 'account.html';
        accountLink.className = 'nav-link';
        accountLink.textContent = 'Account';
        navLinks.appendChild(accountLink);
      }
      const path = 'account.html';
      const links = headerPlaceholder.querySelectorAll('.nav-link');
      links.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === path || 
          link.href.includes('account.html'));
      });
      const hamburger = headerPlaceholder.querySelector('.hamburger');
      const navLinksContainer = headerPlaceholder.querySelector('.nav-links');
      if (hamburger && navLinksContainer) {
        hamburger.addEventListener('click', (e) => {
          e.stopPropagation();
          navLinksContainer.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
          if (!navLinksContainer.contains(e.target) && !hamburger.contains(e.target)) {
            navLinksContainer.classList.remove('open');
          }
        });
        headerPlaceholder.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', () => navLinksContainer.classList.remove('open'));
        });
      }
    })
    .catch(e => console.error('Header load failed:', e));
});
</script>
<script src="bubble-transition.js"></script>
  <script src="bubble-nav.js"></script>
</body>
</html>
