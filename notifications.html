<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notifications - Ripple</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="notifications.css">

</head>
<body>
  <header class="nav">
    <div class="nav-left">
      <div><img src="logo.png" width="75px"></div>
      <div class="logo-text">Ripple</div>
      <button class="hamburger" aria-label="Toggle navigation menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <nav class="nav-links">
        <a class="nav-link" href="main.html">Home</a>
        <a class="nav-link" href="resources.html">Resources</a>
        <a class="nav-link" href="communites.html">Communities</a>
        <a class="nav-link" href="support.html">Support</a>
        <a class="nav-link" href="calender.html">Calendar</a>
      </nav>
    </div>
    <div class="nav-right">
      <a class="notif-icon" href="notifications.html" title="Notifications">N</a>
      <div class="avatar" id="avatarBtn" title="Account" style="cursor:pointer"></div>
    </div>
  </header>

  <main class="notif-page">
    <div class="notif-shell">
      <h1>Notifications & Moderation</h1>
      <p class="small-muted">Pending items for admins/founders will show here. Approve or deny submissions directly.</p>
      <div class="notif-tools">
        <button id="testNotifBtn" class="approve-btn" type="button">Create Test Notification</button>
      </div>

      <div id="notifList"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, addDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBguT9BsQHwsAwAd3mbEmj3S5E7GtR_IBU",
      authDomain: "webmaster-v4-0.firebaseapp.com",
      projectId: "webmaster-v4-0",
      storageBucket: "webmaster-v4-0.firebasestorage.app",
      messagingSenderId: "413556961992",
      appId: "1:413556961992:web:899600895ecb68eb9debfd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.__notifModuleLoaded = true;

    const notifList = document.getElementById('notifList');

    function renderNotif(docSnap) {
      const data = docSnap.data();
      const id = docSnap.id;

      const card = document.createElement('div');
      card.className = 'notif-card';
      const left = document.createElement('div'); left.className = 'notif-left';
      const title = document.createElement('div'); title.className = 'notif-title';
      title.textContent = data.title || data.message || 'Notification';
      const meta = document.createElement('div'); meta.className = 'notif-meta';
      meta.textContent = `${data.itemType || ''} â€¢ Submitted by ${data.createdByEmail || 'unknown'}`;
      left.appendChild(title); left.appendChild(meta);

      const actions = document.createElement('div'); actions.className = 'notif-actions';

      if ((data.type === 'approval' || data.type === 'roleRequest' || data.type === 'test') && data.status === 'unread') {
        const approve = document.createElement('button'); approve.className = 'approve-btn'; approve.textContent = 'Approve';
        const deny = document.createElement('button'); deny.className = 'deny-btn'; deny.textContent = 'Deny';

        approve.addEventListener('click', async () => {
          // Approve: move pending doc to live collection and update notification
          try {
            if (data.type === 'test') {
              // Just mark test as handled
              await updateDoc(doc(db, 'notifications', id), { status: 'handled', handledBy: auth.currentUser.uid, handledAt: serverTimestamp(), result: 'approved' });
              card.remove();
              alert('Test notification approved.');
            } else if (data.type === 'roleRequest') {
              // Approve role request: promote user to admin
              const reqRef = doc(db, 'roleRequests', data.itemId);
              const reqSnap = await getDoc(reqRef);
              if (!reqSnap.exists()) throw new Error('Role request not found');
              const reqData = reqSnap.data();
              const requestorId = reqData.createdBy || data.requestorId || reqData.requestorId;
              if (!requestorId) throw new Error('Requester not found');
              // update user role
              await setDoc(doc(db, 'users', requestorId), { role: 'admin' }, { merge: true });
              // update request status
              await updateDoc(reqRef, { status: 'approved', moderatedBy: auth.currentUser.uid, moderatedAt: serverTimestamp() });
              // update notification
              await updateDoc(doc(db, 'notifications', id), { status: 'handled', handledBy: auth.currentUser.uid, handledAt: serverTimestamp(), result: 'approved' });
              card.remove();
              alert('Role request approved. The user is now an admin.');
            } else {
              const itemRef = doc(db, data.itemType === 'event' ? 'pendingEvents' : 'pendingResources', data.itemId);
              const itemSnap = await getDoc(itemRef);
              if (!itemSnap.exists()) throw new Error('Item not found');
              const itemData = itemSnap.data();
              // create live doc
              await addDoc(collection(db, data.itemType === 'event' ? 'events' : 'resources'), { ...itemData, status: 'approved', approvedAt: serverTimestamp() });
              // update pending item status
              await updateDoc(itemRef, { status: 'approved', moderatedBy: auth.currentUser.uid, moderatedAt: serverTimestamp() });
              // mark notification as handled
              await updateDoc(doc(db, 'notifications', id), { status: 'handled', handledBy: auth.currentUser.uid, handledAt: serverTimestamp(), result: 'approved' });
              card.remove();
              alert('Item approved and published.');
            }
          } catch (err) {
            console.error(err);
            alert('Failed to approve item: ' + err.message);
          }
        });

        deny.addEventListener('click', async () => {
          try {
            if (data.type === 'test') {
              // Just mark test as handled
              await updateDoc(doc(db, 'notifications', id), { status: 'handled', handledBy: auth.currentUser.uid, handledAt: serverTimestamp(), result: 'denied' });
              card.remove();
              alert('Test notification denied.');
            } else if (data.type === 'roleRequest') {
              const reqRef = doc(db, 'roleRequests', data.itemId);
              await updateDoc(reqRef, { status: 'denied', moderatedBy: auth.currentUser.uid, moderatedAt: serverTimestamp() });
              await updateDoc(doc(db, 'notifications', id), { status: 'handled', handledBy: auth.currentUser.uid, handledAt: serverTimestamp(), result: 'denied' });
              card.remove();
              alert('Role request denied.');
            } else {
              const itemRef = doc(db, data.itemType === 'event' ? 'pendingEvents' : 'pendingResources', data.itemId);
              await updateDoc(itemRef, { status: 'denied', moderatedBy: auth.currentUser.uid, moderatedAt: serverTimestamp() });
              await updateDoc(doc(db, 'notifications', id), { status: 'handled', handledBy: auth.currentUser.uid, handledAt: serverTimestamp(), result: 'denied' });
              card.remove();
              alert('Item denied.');
            }
          } catch (err) {
            console.error(err);
            alert('Failed to deny item: ' + err.message);
          }
        });

        actions.appendChild(approve);
        actions.appendChild(deny);
      } else {
        const info = document.createElement('div'); info.textContent = data.message || '';
        actions.appendChild(info);
      }

      card.appendChild(left);
      card.appendChild(actions);
      notifList.appendChild(card);
    }

    // Bootstrap list for founders (temporary for school project)
    const BOOTSTRAP_FOUNDERS = [
      'prayag.patel5240@gmail.com',
      'choppapurandhar@gmail.com'
    ];

    // Test notification creator
    window.createTestNotification = async () => {
      console.log('Test notification button clicked');
      const user = auth.currentUser;
      console.log('Current user:', user ? user.email : 'NOT SIGNED IN');
      if (!user) {
        alert('Not signed in. Please sign in and try again.');
        return;
      }
      try {
        console.log('Creating test notification for', user.email);
        const testData = {
          type: 'test',
          itemType: 'system',
          itemId: user.uid + '_' + Date.now(),
          title: 'ðŸ§ª Test Notification',
          message: `Test created at ${new Date().toLocaleString()}`,
          recipientsRole: ['admin','founder'],
          status: 'unread',
          createdBy: user.uid,
          createdByEmail: user.email || null,
          createdAt: serverTimestamp()
        };
        console.log('Test data:', testData);
        console.log('Calling addDoc...');
        
        // Add timeout to catch hanging promises
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Write timeout - check Firestore rules')), 5000)
        );
        const writePromise = addDoc(collection(db, 'notifications'), testData);
        
        const ref = await Promise.race([writePromise, timeoutPromise]);
        console.log('âœ“ Test notification created successfully with ID:', ref.id);
        alert('âœ“ Test notification created! ID: ' + ref.id);
      } catch (err) {
        console.error('Test notification failed:', err.code, err.message, err);
        alert('Failed: ' + (err.message || JSON.stringify(err)));
      }
    };

    // Wire up test button immediately
    const testNotifBtn = document.getElementById('testNotifBtn');
    if (testNotifBtn) {
      testNotifBtn.addEventListener('click', window.createTestNotification);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      // Header avatar
      const avatar = document.querySelector('.avatar');
      if (avatar) {
        const initial = (user.email || '').charAt(0).toUpperCase();
        if (user.photoURL) {
          avatar.style.backgroundImage = `url('${user.photoURL}')`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.textContent = '';
        } else {
          avatar.style.backgroundImage = '';
          avatar.textContent = initial;
        }
        avatar.style.cursor = 'pointer';
        avatar.onclick = () => window.location.href = 'account.html';
      }

      // Hamburger menu
      const hamburger = document.querySelector('.hamburger');
      const navLinks = document.querySelector('.nav-links');
      if (hamburger && navLinks) {
        hamburger.addEventListener('click', () => navLinks.classList.toggle('open'));
        navLinks.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', () => navLinks.classList.remove('open'));
        });
      }

      const testNotifBtn = document.getElementById('testNotifBtn');

      // Only admins/founders should see pending approvals
      const docRef = doc(db, 'users', user.uid);
      const snap = await getDoc(docRef);
      let role = snap.exists() && snap.data().role ? snap.data().role : 'member';

      // If this user's email is in the bootstrap list, treat them as founder and persist
      if (user.email && BOOTSTRAP_FOUNDERS.includes(user.email.toLowerCase())) {
        role = 'founder';
        try {
          await setDoc(doc(db, 'users', user.uid), { role: 'founder' }, { merge: true });
          console.log('Bootstrapped founder role for', user.email);
        } catch (err) {
          console.warn('Failed to persist bootstrap founder role:', err);
        }
      }

      if (role !== 'admin' && role !== 'founder') {
        if (testNotifBtn) testNotifBtn.style.display = 'none';
        notifList.innerHTML = '<div class="notif-empty">You have no moderation privileges. Contact an admin to gain access.</div>';
        return;
      }

      if (testNotifBtn) {
        testNotifBtn.style.display = 'inline-flex';
      }

      // Admin/founder: listen for approval notifications
      const q = query(collection(db, 'notifications'), where('type', 'in', ['approval', 'roleRequest', 'test']));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        console.log('Notifications snapshot received:', snapshot.size, 'items');
        notifList.innerHTML = '';
        if (snapshot.empty) {
          notifList.innerHTML = '<div class="notif-empty">âœ“ No pending items. You are all caught up!</div>';
          return;
        }
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          console.log('Rendering notification:', data.type, '|', data.title);
          // only show if still pending/unread
          if (data.status === 'unread' || data.status === 'pending') {
            renderNotif(docSnap);
          }
        });
      }, (err) => {
        console.error('Notifications listener error:', err);
        notifList.innerHTML = '<div class="notif-empty">âš  Unable to load notifications. Check Firestore rules. Error: ' + err.message + '</div>';
      });
    });
  </script>
</body>
</html>
