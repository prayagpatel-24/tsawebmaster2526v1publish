<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ripple Resources</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&family=Courgette&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="main.css">
<link rel="stylesheet" href="resources.css">
</head>
<body>
<div id="bubble-layer"></div>
   <div id="header-placeholder"></div>

<div class="main-title">Resources</div>
<div class="sub-title">Events and health resources for the community</div>
<div class="toggle-btns">
<button class="active db">Resources</button>
<button class="dark" style="border: 3px solid white;">Events</button>
</div>
<div id="health-section">
<div class="search-area">
<input type="text" placeholder="Search health resources..." />
<button id="addResourceBtn" class="db">+ Add Resource</button>
</div>

<!-- Resource Modal -->
<div id="resourceModal" style="display:none;" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" id="resourceModalContent">
    <div class="modal-header">
      <div>Add New Resource</div>
      <button id="closeResourceModalBtn" style="background: #f3f4f6; border: 1px solid #e5e7eb; color: #374151; border-radius: 10px; padding: 10px 18px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">✕ Close</button>
    </div>
    <form id="resourceForm">
      <div class="modal-form-group">
        <input id="resourceTitle" type="text" placeholder="Enter resource title" required />
      </div>
      <div class="modal-form-group">
        <input id="resourceDesc1" type="text" placeholder="Short description" />
      </div>
      <div class="modal-form-group">
        <textarea id="resourceDesc2" placeholder="Additional details (optional)" rows="3"></textarea>
      </div>
      <div class="modal-form-group">
        <label for="resourceCategory">Category</label>
        <select id="resourceCategory">
          <option>Mental Health</option>
          <option>Physical Health</option>
          <option>Nutrition</option>
          <option>Wellness</option>
          <option>Support Groups</option>
        </select>
      </div>
      <div class="modal-form-group">
        <input id="resourceUrl" type="text" placeholder="Resource URL (https://...)" />
      </div>
      <div class="modal-form-group">
        <input id="resourceHotline" type="text" placeholder="Hotline number (optional if URL provided)" />
      </div>
      <div class="modal-form-actions">
        <button type="button" id="cancelResourceBtn" class="cancel-btn">Cancel</button>
        <button type="submit" class="submit-btn">Save Resource</button>
      </div>
    </form>
  </div>
</div>

<!-- Resource Detail Modal -->
<div id="resourceDetailModal" style="display:none;" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" id="resourceDetailModalContent">
    <div class="modal-header">
      <div id="resourceDetailTitle">Resource Details</div>
      <button id="closeResourceDetailBtn" style="background: #f3f4f6; border: 1px solid #e5e7eb; color: #374151; border-radius: 10px; padding: 10px 18px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">✕ Close</button>
    </div>
    <div class="event-detail-body">
      <div class="event-detail-meta" id="resourceDetailMeta"></div>
      <div class="event-detail-desc" id="resourceDetailDesc"></div>
    </div>
    <div class="modal-form-actions">
      <button type="button" id="resourceDetailRemoveBtn" class="cancel-btn">Remove Resource</button>
      <a id="resourceDetailActionBtn" class="submit-btn" href="#" target="_blank" rel="noopener noreferrer" style="display:none; text-decoration:none; align-items:center; justify-content:center;">Open Resource</a>
      <button type="button" id="resourceDetailSaveBtn" class="submit-btn">Save Resource</button>
    </div>
  </div>
</div>

<div class="filters">
<button class="active db">All</button>
<button class="dark">Mental Health</button>
<button class="dark">Physical Health</button>
<button class="dark">Nutrition</button>
<button class="dark">Wellness</button>
<button class="dark">Support Groups</button>
</div>
<div class="cards">
<div class="card cardMen hov" data-url="https://988lifeline.org/" data-hotline="988"><h3>988 Suicide & Crisis Lifeline</h3><p>24/7 immediate support for mental health crises and emotional distress.</p><p>Call, text, or chat with trained counselors for free support.</p><div class="tag blue">Mental Health</div></div>
<div class="card cardMen hov" data-url="https://www.samhsa.gov/find-help/national-helpline" data-hotline="1-800-662-4357"><h3>SAMHSA National Helpline</h3><p>Confidential referral and information service for mental health and substance use support.</p><p>Available 24/7 in English and Spanish.</p><div class="tag blue">Mental Health</div></div>
<div class="card cardDon hov" data-url="https://www.theplaceofforsyth.org/" data-hotline="770-887-1098"><h3>The Place Forsyth</h3><p>Local support hub for food assistance, donations, and community services.</p><p>Find local drives and support programs for families in need.</p><div class="tag red">Support Groups</div></div>
<div class="card cardEnv hov" data-url="https://www.cdc.gov/physical-activity-basics/benefits/index.html"><h3>CDC Physical Activity Basics</h3><p>Evidence-based guides for building a weekly movement routine.</p><p>Great starter resource for all fitness levels.</p><div class="tag green">Physical Health</div></div>
<div class="card cardVol hov" data-url="https://www.myplate.gov/"><h3>USDA MyPlate Nutrition Guide</h3><p>Practical meal-planning tips and nutrition basics for families and students.</p><p>Use food-group tools and healthy recipe ideas.</p><div class="tag orange">Nutrition</div></div>
<div class="card cardCom hov" data-url="https://www.nimh.nih.gov/health/topics/caring-for-your-mental-health"><h3>NIMH Wellness Toolkit</h3><p>Science-backed strategies for stress management, sleep, and daily routines.</p><p>Helpful for students, parents, and busy schedules.</p><div class="tag purple">Wellness</div></div>
<div class="card cardDon hov" data-url="https://www.nami.org/support-education/support-groups/"><h3>NAMI Support Groups</h3><p>Find peer-led support groups for individuals and families.</p><p>Includes options for ongoing weekly support.</p><div class="tag red">Support Groups</div></div>
<div class="card cardMen hov" data-url="https://www.crisistextline.org/" data-hotline="Text HOME to 741741"><h3>Crisis Text Line</h3><p>Free text-based support with trained crisis counselors.</p><p>Ideal when calling is difficult or privacy is needed.</p><div class="tag blue">Mental Health</div></div>
<div class="card cardEnv hov" data-url="https://www.keepforsythcountybeautiful.org/"><h3>Keep Forsyth County Beautiful</h3><p>Environmental volunteer opportunities, cleanups, and recycling education.</p><p>Join local efforts focused on sustainability and water quality.</p><div class="tag green">Physical Health</div></div>
<div class="card cardVol hov" data-url="https://www.eatright.org/"><h3>Academy of Nutrition and Dietetics</h3><p>Trusted nutrition education from registered dietitians.</p><p>Browse healthy eating guides for all age groups.</p><div class="tag orange">Nutrition</div></div>
<div class="card cardCom hov" data-url="https://www.sleepfoundation.org/"><h3>Sleep Foundation Guides</h3><p>Actionable sleep hygiene tips and routines for better recovery.</p><p>Includes teen and student-friendly recommendations.</p><div class="tag purple">Wellness</div></div>
<div class="card cardDon hov" data-url="https://www.forsythpl.org/"><h3>Forsyth County Public Library Programs</h3><p>Community classes, support events, and educational workshops.</p><p>Track local meetups and public wellness sessions.</p><div class="tag red">Support Groups</div></div>
</div>
</div>

<div id="events-section" style="display:none;">
<div class="search-area">
<input type="text" placeholder="Search events..." />
<input type="date" />
<button id="addEventBtn" class="db">+ Add Event</button>
</div>

<!-- Event Modal -->
<div id="eventModal" style="display:none;" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" id="eventModalContent">
    <div class="modal-header">
      <div id="eventModalTitle">Add New Event</div>
      <button id="closeModalBtn" style="background: #f3f4f6; border: 1px solid #e5e7eb; color: #374151; border-radius: 10px; padding: 10px 18px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">✕ Close</button>
    </div>
    <form id="eventForm">
      <div class="modal-form-group">
        <input id="eventTitle" type="text" placeholder="Event title" required />
      </div>
      <div class="modal-form-row">
        <input id="eventDate" type="date" required />
        <input id="eventTime" type="time" />
        <input id="eventLocation" type="text" placeholder="Location" />
      </div>
      <div class="modal-form-group">
        <textarea id="eventDesc" placeholder="Event description" rows="4"></textarea>
      </div>
      <div class="modal-form-group">
        <input id="eventUrl" type="text" placeholder="Event page URL (https://...)" />
      </div>
      <div class="modal-form-group">
        <input id="eventHotline" type="text" placeholder="Hotline number (optional if URL provided)" />
      </div>
      <div class="modal-form-group">
        <label for="eventCategory">Category</label>
        <select id="eventCategory">
          <option>Environmental</option>
          <option>Mental Health</option>
          <option>Volunteering</option>
          <option>Donation Drives</option>
          <option>Community Events</option>
        </select>
      </div>
      <div class="modal-form-actions">
        <button type="button" id="cancelBtn" class="cancel-btn">Cancel</button>
        <button type="submit" class="submit-btn">Save Event</button>
      </div>
    </form>
  </div>
</div>

<!-- Event Detail Modal -->
<div id="eventDetailModal" style="display:none;" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" id="eventDetailModalContent">
    <div class="modal-header">
      <div id="eventDetailTitle">Event Details</div>
      <button id="closeEventDetailBtn" style="background: #f3f4f6; border: 1px solid #e5e7eb; color: #374151; border-radius: 10px; padding: 10px 18px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s ease;">✕ Close</button>
    </div>
    <div class="event-detail-body">
      <div class="event-detail-meta" id="eventDetailMeta"></div>
      <div class="event-detail-desc" id="eventDetailDesc"></div>
    </div>
    <div class="modal-form-actions">
      <button type="button" id="eventDetailEditBtn" class="cancel-btn" style="display:none;">Edit Event</button>
      <button type="button" id="eventDetailRemoveBtn" class="cancel-btn">Remove Event</button>
      <a id="eventDetailActionBtn" class="submit-btn" href="#" target="_blank" rel="noopener noreferrer" style="display:none; text-decoration:none; align-items:center; justify-content:center;">Open Event Link</a>
      <button type="button" id="eventDetailSignupBtn" class="submit-btn">Sign Up</button>
    </div>
  </div>
</div>

<div class="filters">
<button class="active db">All</button>
<button class="dark">Mental Health</button>
<button class="dark">Volunteering</button>
<button class="dark">Environmental</button>
<button class="dark">Community Events</button>
<button class="dark">Donation Drives</button>
</div>
<div class="cards">
<div class="card cardEnv hov" data-title="Big Creek Greenway Cleanup" data-date="Mar 8, 2026" data-time="9:00 AM - 12:00 PM" data-location="Big Creek Greenway Trailhead" data-desc="Join neighbors for a Forsyth County trail cleanup and litter audit." data-category="Environmental"><h3>Big Creek Greenway Cleanup</h3><p>Mar 8, 2026 | 9:00 AM – 12:00 PM<br>Big Creek Greenway Trailhead</p><p>Join neighbors for a Forsyth County trail cleanup and litter audit.</p><div class="tag green">Environmental</div></div>
<div class="card cardMen hov" data-title="Lake Lanier Wellness Walk" data-date="Mar 15, 2026" data-time="8:30 AM - 10:30 AM" data-location="Lanier Park Trail" data-desc="Community walk supporting mental health awareness and local resources." data-category="Mental Health"><h3>Lake Lanier Wellness Walk</h3><p>Mar 15, 2026 | 8:30 AM – 10:30 AM<br>Lanier Park Trail</p><p>Community walk supporting mental health awareness and local resources.</p><div class="tag blue">Mental Health</div></div>
<div class="card cardVol hov" data-title="Forsyth Blood Drive" data-date="Mar 22, 2026" data-time="10:00 AM - 3:00 PM" data-location="Cumming City Center" data-desc="Partner with local hospitals for a community blood drive to save lives." data-category="Volunteering"><h3>Forsyth Blood Drive</h3><p>Mar 22, 2026 | 10:00 AM – 3:00 PM<br>Cumming City Center</p><p>Partner with local hospitals for a community blood drive to save lives.</p><div class="tag orange">Volunteering</div></div>
<div class="card cardDon hov" data-title="Sharon Forks Book Drive" data-date="Mar 29, 2026" data-time="11:00 AM - 2:00 PM" data-location="Sharon Forks Library" data-desc="Collect and sort books for local classrooms and family literacy." data-category="Donation Drives"><h3>Sharon Forks Book Drive</h3><p>Mar 29, 2026 | 11:00 AM – 2:00 PM<br>Sharon Forks Library</p><p>Collect and sort books for local classrooms and family literacy.</p><div class="tag red">Donation Drives</div></div>
<div class="card cardCom hov" data-title="Forsyth Cultural Expo" data-date="Apr 5, 2026" data-time="12:00 PM - 6:00 PM" data-location="Forsyth Central Park" data-desc="Celebrate community traditions with performances, food, and art." data-category="Community Events"><h3>Forsyth Cultural Expo</h3><p>Apr 5, 2026 | 12:00 PM – 6:00 PM<br>Forsyth Central Park</p><p>Celebrate community traditions with performances, food, and art.</p><div class="tag purple">Community Events</div></div>
<div class="card cardEnv hov" data-title="Fowler Park Reforestation" data-date="Apr 12, 2026" data-time="9:30 AM - 1:30 PM" data-location="Fowler Park" data-desc="Plant native trees to strengthen Forsyth County green spaces." data-category="Environmental"><h3>Fowler Park Reforestation</h3><p>Apr 12, 2026 | 9:30 AM – 1:30 PM<br>Fowler Park</p><p>Plant native trees to strengthen Forsyth County green spaces.</p><div class="tag green">Environmental</div></div>
<div class="card cardCom hov" data-title="Summer Kickoff Community Fair" data-date="Jun 6, 2026" data-time="10:00 AM - 4:00 PM" data-location="Cumming Fairgrounds" data-desc="Kick off summer with booths, youth clubs, and family activities." data-category="Community Events"><h3>Summer Kickoff Community Fair</h3><p>Jun 6, 2026 | 10:00 AM – 4:00 PM<br>Cumming Fairgrounds</p><p>Kick off summer with booths, youth clubs, and family activities.</p><div class="tag purple">Community Events</div></div>
<div class="card cardEnv hov" data-title="Lanier Shoreline Cleanup" data-date="Jun 13, 2026" data-time="8:00 AM - 11:30 AM" data-location="Lake Lanier North Dock" data-desc="Collect shoreline litter and protect wildlife habitats around Lanier." data-category="Environmental"><h3>Lanier Shoreline Cleanup</h3><p>Jun 13, 2026 | 8:00 AM – 11:30 AM<br>Lake Lanier North Dock</p><p>Collect shoreline litter and protect wildlife habitats around Lanier.</p><div class="tag green">Environmental</div></div>
<div class="card cardVol hov" data-title="Youth Volunteer Orientation Day" data-date="Jun 20, 2026" data-time="11:00 AM - 1:00 PM" data-location="Forsyth Service Center" data-desc="Get matched with summer volunteer projects for teens and families." data-category="Volunteering"><h3>Youth Volunteer Orientation Day</h3><p>Jun 20, 2026 | 11:00 AM – 1:00 PM<br>Forsyth Service Center</p><p>Get matched with summer volunteer projects for teens and families.</p><div class="tag orange">Volunteering</div></div>
<div class="card cardMen hov" data-title="Mindful Summer Reset Workshop" data-date="Jun 27, 2026" data-time="9:30 AM - 11:30 AM" data-location="Sharon Forks Community Hall" data-desc="Guided stress-management and mindfulness tools for summer routines." data-category="Mental Health"><h3>Mindful Summer Reset Workshop</h3><p>Jun 27, 2026 | 9:30 AM – 11:30 AM<br>Sharon Forks Community Hall</p><p>Guided stress-management and mindfulness tools for summer routines.</p><div class="tag blue">Mental Health</div></div>
<div class="card cardDon hov" data-title="Backpack Essentials Drive" data-date="Jul 4, 2026" data-time="12:00 PM - 3:00 PM" data-location="Midway Park Pavilion" data-desc="Donate school essentials to prepare students for the fall semester." data-category="Donation Drives"><h3>Backpack Essentials Drive</h3><p>Jul 4, 2026 | 12:00 PM – 3:00 PM<br>Midway Park Pavilion</p><p>Donate school essentials to prepare students for the fall semester.</p><div class="tag red">Donation Drives</div></div>
<div class="card cardCom hov" data-title="Neighborhood Picnic and Games" data-date="Jul 11, 2026" data-time="1:00 PM - 5:00 PM" data-location="Sawnee Mountain Preserve Lawn" data-desc="Community picnic with music, games, and local nonprofit booths." data-category="Community Events"><h3>Neighborhood Picnic and Games</h3><p>Jul 11, 2026 | 1:00 PM – 5:00 PM<br>Sawnee Mountain Preserve Lawn</p><p>Community picnic with music, games, and local nonprofit booths.</p><div class="tag purple">Community Events</div></div>
<div class="card cardEnv hov" data-title="Trail Water Station Volunteer Day" data-date="Jul 18, 2026" data-time="7:30 AM - 10:30 AM" data-location="Big Creek Greenway Mile 3" data-desc="Support runners and walkers while promoting hydration and safety." data-category="Environmental"><h3>Trail Water Station Volunteer Day</h3><p>Jul 18, 2026 | 7:30 AM – 10:30 AM<br>Big Creek Greenway Mile 3</p><p>Support runners and walkers while promoting hydration and safety.</p><div class="tag green">Environmental</div></div>
<div class="card cardMen hov" data-title="Community Wellness Check-In" data-date="Jul 25, 2026" data-time="10:00 AM - 12:00 PM" data-location="Forsyth Central Library" data-desc="Open discussion circle on burnout, boundaries, and community care." data-category="Mental Health"><h3>Community Wellness Check-In</h3><p>Jul 25, 2026 | 10:00 AM – 12:00 PM<br>Forsyth Central Library</p><p>Open discussion circle on burnout, boundaries, and community care.</p><div class="tag blue">Mental Health</div></div>
<div class="card cardVol hov" data-title="Senior Center Support Shift" data-date="Aug 1, 2026" data-time="9:00 AM - 1:00 PM" data-location="Cumming Senior Center" data-desc="Help with meal prep, games, and activity support for seniors." data-category="Volunteering"><h3>Senior Center Support Shift</h3><p>Aug 1, 2026 | 9:00 AM – 1:00 PM<br>Cumming Senior Center</p><p>Help with meal prep, games, and activity support for seniors.</p><div class="tag orange">Volunteering</div></div>
<div class="card cardDon hov" data-title="Community Hygiene Kit Drive" data-date="Aug 8, 2026" data-time="11:00 AM - 2:00 PM" data-location="Vickery Village Plaza" data-desc="Assemble hygiene kits for families and individuals in need." data-category="Donation Drives"><h3>Community Hygiene Kit Drive</h3><p>Aug 8, 2026 | 11:00 AM – 2:00 PM<br>Vickery Village Plaza</p><p>Assemble hygiene kits for families and individuals in need.</p><div class="tag red">Donation Drives</div></div>
<div class="card cardCom hov" data-title="Local Arts and Culture Night" data-date="Aug 15, 2026" data-time="5:30 PM - 8:30 PM" data-location="Cumming City Center Stage" data-desc="Celebrate local artists, student performers, and neighborhood stories." data-category="Community Events"><h3>Local Arts and Culture Night</h3><p>Aug 15, 2026 | 5:30 PM – 8:30 PM<br>Cumming City Center Stage</p><p>Celebrate local artists, student performers, and neighborhood stories.</p><div class="tag purple">Community Events</div></div>
<div class="card cardEnv hov" data-title="End-of-Summer Park Cleanup" data-date="Aug 22, 2026" data-time="8:30 AM - 12:00 PM" data-location="Fowler Park East Entrance" data-desc="Close out summer with park cleanup and recycling education stations." data-category="Environmental"><h3>End-of-Summer Park Cleanup</h3><p>Aug 22, 2026 | 8:30 AM – 12:00 PM<br>Fowler Park East Entrance</p><p>Close out summer with park cleanup and recycling education stations.</p><div class="tag green">Environmental</div></div>
<div class="card cardMen hov" data-title="Back-to-School Resilience Session" data-date="Aug 29, 2026" data-time="10:30 AM - 12:00 PM" data-location="South Forsyth High Commons" data-desc="Practical tools for managing stress and routines before school starts." data-category="Mental Health"><h3>Back-to-School Resilience Session</h3><p>Aug 29, 2026 | 10:30 AM – 12:00 PM<br>South Forsyth High Commons</p><p>Practical tools for managing stress and routines before school starts.</p><div class="tag blue">Mental Health</div></div>
</div>
</div>
<footer class="footer" style="margin-top: 100px; width: 100%">
  <div id="footer-placeholder"></div>
</footer>

<script>
// Modal and event creation (inline JS)
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('eventModal');
  const eventModalTitle = document.getElementById('eventModalTitle');
  const addBtn = document.getElementById('addEventBtn');
  const closeBtn = document.getElementById('closeModalBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const form = document.getElementById('eventForm');
  const cards = document.querySelector('#events-section .cards');

  const eventDetailModal = document.getElementById('eventDetailModal');
  const eventDetailModalContent = document.getElementById('eventDetailModalContent');
  const closeEventDetailBtn = document.getElementById('closeEventDetailBtn');
  const eventDetailTitle = document.getElementById('eventDetailTitle');
  const eventDetailMeta = document.getElementById('eventDetailMeta');
  const eventDetailDesc = document.getElementById('eventDetailDesc');
  const eventDetailSignupBtn = document.getElementById('eventDetailSignupBtn');
  const eventDetailEditBtn = document.getElementById('eventDetailEditBtn');
  const eventDetailRemoveBtn = document.getElementById('eventDetailRemoveBtn');
  const eventDetailActionBtn = document.getElementById('eventDetailActionBtn');

  // Resource modal
  const resourceModal = document.getElementById('resourceModal');
  const addResourceBtn = document.getElementById('addResourceBtn');
  const closeResourceBtn = document.getElementById('closeResourceModalBtn');
  const cancelResourceBtn = document.getElementById('cancelResourceBtn');
  const resourceForm = document.getElementById('resourceForm');
  const resourceCards = document.querySelector('#health-section .cards');
  const resourceDetailModal = document.getElementById('resourceDetailModal');
  const resourceDetailModalContent = document.getElementById('resourceDetailModalContent');
  const closeResourceDetailBtn = document.getElementById('closeResourceDetailBtn');
  const resourceDetailTitle = document.getElementById('resourceDetailTitle');
  const resourceDetailMeta = document.getElementById('resourceDetailMeta');
  const resourceDetailDesc = document.getElementById('resourceDetailDesc');
  const resourceDetailSaveBtn = document.getElementById('resourceDetailSaveBtn');
  const resourceDetailRemoveBtn = document.getElementById('resourceDetailRemoveBtn');
  const resourceDetailActionBtn = document.getElementById('resourceDetailActionBtn');

  // Toggle functionality
  const toggleBtns = document.querySelectorAll('.toggle-btns button');
  const healthSection = document.getElementById('health-section');
  const eventsSection = document.getElementById('events-section');

  let editingEventCard = null;
  let isEditingEvent = false;

  // Check if we should show events on page load
  const urlParams = new URLSearchParams(window.location.search);
  const showEvents = urlParams.get('tab') === 'events';

  if (showEvents) {
    toggleBtns.forEach(b => b.classList.remove('active'));
    toggleBtns[1].classList.add('active');
    healthSection.style.display = 'none';
    eventsSection.style.display = 'block';
  }

  toggleBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      toggleBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      if (this.textContent === 'Resources') {
        healthSection.style.display = 'block';
        eventsSection.style.display = 'none';
      } else {
        healthSection.style.display = 'none';
        eventsSection.style.display = 'block';
      }
    });
  });

  function normalizeText(value) {
    return (value || '').toLowerCase();
  }

  function logFirebaseError(context, err, extra = {}) {
    console.error(`[Firebase:${context}]`, {
      code: err && err.code ? err.code : 'unknown',
      message: err && err.message ? err.message : String(err),
      ...extra,
      raw: err
    });
  }

  function toDateKey(value) {
    if (!value) return '';
    if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
    const parsed = new Date(value);
    if (isNaN(parsed)) return '';
    return parsed.toISOString().slice(0, 10);
  }

  function formatDateForDisplay(value) {
    if (!value) return '';
    const parsed = new Date(value);
    if (isNaN(parsed)) return value;
    return parsed.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function normalizeUrl(value) {
    const v = (value || '').trim();
    if (!v) return '';
    if (/^https?:\/\//i.test(v)) return v;
    return `https://${v}`;
  }

  function hasActionTarget(url, hotline) {
    return !!((url || '').trim() || (hotline || '').trim());
  }

  function setEventCardData(card, data) {
    card.dataset.title = data.title || '';
    card.dataset.date = data.date || '';
    card.dataset.dateKey = data.dateKey || toDateKey(data.date) || '';
    card.dataset.time = data.time || '';
    card.dataset.location = data.location || '';
    card.dataset.desc = data.desc || '';
    card.dataset.category = data.category || '';
    card.dataset.url = data.url || '';
    card.dataset.hotline = data.hotline || '';
    card.dataset.status = data.status || '';
    card.dataset.docId = data.docId || '';
    card.dataset.sourceFirestore = data.sourceFirestore ? '1' : '';
    card.dataset.search = normalizeText(
      [data.title, data.date, data.time, data.location, data.desc, data.category, data.url, data.hotline].join(' ')
    );
  }

  function setResourceCardData(card, data) {
    card.dataset.title = data.title || '';
    card.dataset.desc1 = data.desc1 || '';
    card.dataset.desc2 = data.desc2 || '';
    card.dataset.category = data.category || '';
    card.dataset.url = data.url || '';
    card.dataset.hotline = data.hotline || '';
    card.dataset.status = data.status || '';
    card.dataset.docId = data.docId || '';
    card.dataset.sourceFirestore = data.sourceFirestore ? '1' : '';
    card.dataset.search = normalizeText(
      [data.title, data.desc1, data.desc2, data.category, data.url, data.hotline].join(' ')
    );
  }

  async function removeEventCard(card) {
    if (!card) return;
    const title = card.dataset.title || '';
    const docId = card.dataset.docId || '';
    const isFirestoreItem = card.dataset.sourceFirestore === '1';

    if (isFirestoreItem && docId && window.deleteEventByDocId) {
      await window.deleteEventByDocId(docId);
    }

    removePendingLocalByTitle('pendingEvents', title);
    card.remove();
    applyEventFilters();
  }

  async function removeResourceCard(card) {
    if (!card) return;
    const title = card.dataset.title || '';
    const docId = card.dataset.docId || '';
    const isFirestoreItem = card.dataset.sourceFirestore === '1';

    if (isFirestoreItem && docId && window.deleteResourceByDocId) {
      await window.deleteResourceByDocId(docId, title);
    }

    removePendingLocalByTitle('pendingResources', title);
    card.remove();
    applyResourceFilters();
  }

  function loadPendingLocal(key) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      return [];
    }
  }

  function savePendingLocal(key, list) {
    try {
      localStorage.setItem(key, JSON.stringify(list));
    } catch (e) {}
  }

  function addPendingLocal(key, item) {
    const list = loadPendingLocal(key);
    list.unshift({ ...item, _ts: Date.now() });
    savePendingLocal(key, list);
  }

  function removePendingLocalByTitle(key, title) {
    const list = loadPendingLocal(key);
    const next = list.filter(it => (it.title || '').trim().toLowerCase() !== (title || '').trim().toLowerCase());
    savePendingLocal(key, next);
  }

  function cleanupPendingLocal(key, maxAgeMs) {
    const list = loadPendingLocal(key);
    const now = Date.now();
    const next = list.filter(it => !it._ts || (now - it._ts) <= maxAgeMs);
    savePendingLocal(key, next);
  }

  function saveLocalActionFallback(key, payload) {
    try {
      const current = JSON.parse(localStorage.getItem(key) || '[]');
      current.unshift({ ...payload, _localTs: Date.now() });
      localStorage.setItem(key, JSON.stringify(current.slice(0, 200)));
    } catch (err) {
      console.warn('Local action fallback save failed:', err.message);
    }
  }

  function applyResourceFilters() {
    const resourceFilterBtn = document.querySelector('#health-section .filters button.active');
    const activeFilter = resourceFilterBtn ? resourceFilterBtn.textContent.trim() : 'All';
    const searchTerm = normalizeText(resourceSearchInput.value);
    const cards = document.querySelectorAll('#health-section .card');
    cards.forEach(card => {
      const tag = card.querySelector('.tag') ? card.querySelector('.tag').textContent.trim() : '';
      const haystack = card.dataset.search || normalizeText(card.textContent);
      const matchesSearch = !searchTerm || haystack.includes(searchTerm);
      const matchesFilter = activeFilter === 'All' || tag === activeFilter;
      card.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
    });
  }

  function applyEventFilters() {
    const eventFilterBtn = document.querySelector('#events-section .filters button.active');
    const activeFilter = eventFilterBtn ? eventFilterBtn.textContent.trim() : 'All';
    const searchTerm = normalizeText(eventSearchInput.value);
    const cards = document.querySelectorAll('#events-section .card');
    cards.forEach(card => {
      const tag = card.querySelector('.tag') ? card.querySelector('.tag').textContent.trim() : '';
      const haystack = card.dataset.search || normalizeText(card.textContent);
      const matchesSearch = !searchTerm || haystack.includes(searchTerm);
      const matchesFilter = activeFilter === 'All' || tag === activeFilter;
      card.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
    });
  }

  function openModal() {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    updateEventModalStyle();
  }

  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    form.reset();
    isEditingEvent = false;
    editingEventCard = null;
    if (eventModalTitle) eventModalTitle.textContent = 'Add New Event';
  }

  function openResourceModal() {
    resourceModal.style.display = 'flex';
    resourceModal.setAttribute('aria-hidden', 'false');
    updateResourceModalStyle();
  }

  function closeResourceModal() {
    resourceModal.style.display = 'none';
    resourceModal.setAttribute('aria-hidden', 'true');
    resourceForm.reset();
  }

  function openEventDetail(card) {
    if (!card) return;
    const title = card.dataset.title || card.querySelector('h3')?.textContent || 'Event';
    const date = card.dataset.date || '';
    const dateKey = card.dataset.dateKey || toDateKey(date) || '';
    const time = card.dataset.time || '';
    const location = card.dataset.location || '';
    const desc = card.dataset.desc || '';
    const category = card.dataset.category || (card.querySelector('.tag')?.textContent || '');
    const url = card.dataset.url || '';
    const hotline = card.dataset.hotline || '';

    eventDetailTitle.textContent = title;
    eventDetailMeta.textContent = [date, time, location].filter(Boolean).join(' | ');
    const actionLine = hotline ? ` Hotline: ${hotline}` : '';
    eventDetailDesc.textContent = (desc || 'No description provided.') + actionLine;
    if (card.dataset.status === 'pending') {
      eventDetailDesc.textContent = `${eventDetailDesc.textContent} (Pending approval)`;
    }

    const categoryMap = {
      'Environmental': 'category-environmental',
      'Mental Health': 'category-mental-health',
      'Volunteering': 'category-volunteering',
      'Donation Drives': 'category-donation-drives',
      'Community Events': 'category-community-events'
    };
    eventDetailModalContent.className = 'modal-content';
    if (categoryMap[category]) {
      eventDetailModalContent.classList.add(categoryMap[category]);
    }

    const role = (window.currentUserRole || 'member').toLowerCase();
    if (role === 'admin' || role === 'founder') {
      eventDetailEditBtn.style.display = 'inline-flex';
      eventDetailEditBtn.onclick = function() {
        openEditFromCard(card);
      };
    } else {
      eventDetailEditBtn.style.display = 'none';
    }

    if (eventDetailActionBtn) {
      if (url) {
        eventDetailActionBtn.style.display = 'inline-flex';
        eventDetailActionBtn.textContent = 'Open Event Link';
        eventDetailActionBtn.href = normalizeUrl(url);
        eventDetailActionBtn.target = '_blank';
      } else if (hotline) {
        const tel = `tel:${hotline.replace(/[^\d+]/g, '')}`;
        eventDetailActionBtn.style.display = 'inline-flex';
        eventDetailActionBtn.textContent = `Call ${hotline}`;
        eventDetailActionBtn.href = tel;
        eventDetailActionBtn.target = '_self';
      } else {
        eventDetailActionBtn.style.display = 'none';
        eventDetailActionBtn.href = '#';
      }
    }

    eventDetailSignupBtn.onclick = function() {
      if (window.createEventSignup) {
        window.createEventSignup({
          title,
          date: dateKey || date,
          dateKey: dateKey || toDateKey(date),
          time,
          location,
          desc,
          category,
          url,
          hotline
        }).then(() => {
          alert('You are signed up for this event. Check notifications for details.');
          closeEventDetailModal();
        }).catch(err => {
          logFirebaseError('eventSignup.ui', err, { title, dateKey });
          saveLocalActionFallback('rippleLocalEventSignups', {
            title,
            date: dateKey || date,
            dateKey: dateKey || toDateKey(date),
            time,
            location,
            desc,
            category
          });
          alert('Event signup was saved locally on this device.');
          closeEventDetailModal();
        });
      } else {
        alert('Signup is not available right now.');
      }
    };

    eventDetailRemoveBtn.onclick = async function() {
      if (!confirm(`Remove event "${title}"?`)) return;
      try {
        await removeEventCard(card);
        closeEventDetailModal();
      } catch (err) {
        console.error('Event removal failed', err);
        alert('Failed to remove this event.');
      }
    };

    eventDetailModal.style.display = 'flex';
    eventDetailModal.setAttribute('aria-hidden', 'false');
  }

  function openResourceDetail(card) {
    if (!card) return;
    const title = card.dataset.title || card.querySelector('h3')?.textContent || 'Resource';
    const desc1 = card.dataset.desc1 || card.querySelectorAll('p')[0]?.textContent || '';
    const desc2 = card.dataset.desc2 || card.querySelectorAll('p')[1]?.textContent || '';
    const category = card.dataset.category || (card.querySelector('.tag')?.textContent || '');
    const resourceDocId = card.dataset.docId || '';
    const url = card.dataset.url || '';
    const hotline = card.dataset.hotline || '';

    resourceDetailTitle.textContent = title;
    resourceDetailMeta.textContent = category || 'Resource';
    const detailParts = [desc1, desc2].filter(Boolean);
    if (hotline) detailParts.push(`Hotline: ${hotline}`);
    resourceDetailDesc.textContent = detailParts.join(' ');
    if (card.dataset.status === 'pending') {
      resourceDetailDesc.textContent = `${resourceDetailDesc.textContent} (Pending approval)`;
    }

    const categoryMap = {
      'Mental Health': 'category-mental-health',
      'Physical Health': 'category-physical-health',
      'Nutrition': 'category-nutrition',
      'Wellness': 'category-wellness',
      'Support Groups': 'category-support-groups'
    };
    resourceDetailModalContent.className = 'modal-content';
    if (categoryMap[category]) {
      resourceDetailModalContent.classList.add(categoryMap[category]);
    }

    if (resourceDetailActionBtn) {
      if (url) {
        resourceDetailActionBtn.style.display = 'inline-flex';
        resourceDetailActionBtn.textContent = 'Open Resource';
        resourceDetailActionBtn.href = normalizeUrl(url);
        resourceDetailActionBtn.target = '_blank';
      } else if (hotline) {
        const tel = `tel:${hotline.replace(/[^\d+]/g, '')}`;
        resourceDetailActionBtn.style.display = 'inline-flex';
        resourceDetailActionBtn.textContent = `Call ${hotline}`;
        resourceDetailActionBtn.href = tel;
        resourceDetailActionBtn.target = '_self';
      } else {
        resourceDetailActionBtn.style.display = 'none';
        resourceDetailActionBtn.href = '#';
      }
    }

    resourceDetailSaveBtn.onclick = function() {
      if (window.createResourceSave) {
        window.createResourceSave({
          title,
          desc1,
          desc2,
          category,
          resourceDocId,
          url,
          hotline
        }).then(() => {
          alert('Resource saved. Check notifications for details.');
          closeResourceDetailModal();
        }).catch(err => {
          logFirebaseError('resourceSave.ui', err, { title, resourceDocId });
          saveLocalActionFallback('rippleLocalResourceSaves', {
            title,
            desc1,
            desc2,
            category,
            resourceDocId,
            url,
            hotline,
            dateKey: new Date().toISOString().slice(0, 10)
          });
          alert('Resource save was stored locally on this device.');
          closeResourceDetailModal();
        });
      } else {
        alert('Save is not available right now.');
      }
    };

    resourceDetailRemoveBtn.onclick = async function() {
      if (!confirm(`Remove resource "${title}"?`)) return;
      try {
        await removeResourceCard(card);
        closeResourceDetailModal();
      } catch (err) {
        console.error('Resource removal failed', err);
        alert('Failed to remove this resource.');
      }
    };

    resourceDetailModal.style.display = 'flex';
    resourceDetailModal.setAttribute('aria-hidden', 'false');
  }

  function closeResourceDetailModal() {
    resourceDetailModal.style.display = 'none';
    resourceDetailModal.setAttribute('aria-hidden', 'true');
  }

  function closeEventDetailModal() {
    eventDetailModal.style.display = 'none';
    eventDetailModal.setAttribute('aria-hidden', 'true');
  }

  function openEditFromCard(card) {
    if (!card) return;
    isEditingEvent = true;
    editingEventCard = card;
    if (eventModalTitle) eventModalTitle.textContent = 'Edit Event';
    document.getElementById('eventTitle').value = card.dataset.title || '';
    const parsedDate = (card.dataset.dateKey || card.dataset.date) ? new Date(card.dataset.dateKey || card.dataset.date) : null;
    document.getElementById('eventDate').value = parsedDate && !isNaN(parsedDate) ? parsedDate.toISOString().slice(0, 10) : '';
    document.getElementById('eventTime').value = card.dataset.time || '';
    document.getElementById('eventLocation').value = card.dataset.location || '';
    document.getElementById('eventDesc').value = card.dataset.desc || '';
    document.getElementById('eventUrl').value = card.dataset.url || '';
    document.getElementById('eventHotline').value = card.dataset.hotline || '';
    document.getElementById('eventCategory').value = card.dataset.category || 'Community Events';
    updateEventModalStyle();
    openModal();
    closeEventDetailModal();
  }

  function updateEventModalStyle() {
    const eventModalContent = document.getElementById('eventModalContent');
    const category = document.getElementById('eventCategory').value;
    const categoryMap = {
      'Environmental': 'category-environmental',
      'Mental Health': 'category-mental-health',
      'Volunteering': 'category-volunteering',
      'Donation Drives': 'category-donation-drives',
      'Community Events': 'category-community-events'
    };

    eventModalContent.className = 'modal-content';
    if (categoryMap[category]) {
      eventModalContent.classList.add(categoryMap[category]);
    }
  }

  function updateResourceModalStyle() {
    const resourceModalContent = document.getElementById('resourceModalContent');
    const category = document.getElementById('resourceCategory').value;
    const categoryMap = {
      'Mental Health': 'category-mental-health',
      'Physical Health': 'category-physical-health',
      'Nutrition': 'category-nutrition',
      'Wellness': 'category-wellness',
      'Support Groups': 'category-support-groups'
    };

    resourceModalContent.className = 'modal-content';
    if (categoryMap[category]) {
      resourceModalContent.classList.add(categoryMap[category]);
    }
  }

  function setupEventCard(card) {
    if (!card) return;
    card.addEventListener('click', function() {
      openEventDetail(card);
    });
  }

  function buildEventCardFromData(data) {
    const card = document.createElement('div');
    card.className = 'card hov';

    const tagDiv = document.createElement('div');
    tagDiv.className = 'tag';

    switch(data.category){
      case 'Environmental': card.classList.add('cardEnv'); tagDiv.classList.add('green'); break;
      case 'Mental Health': card.classList.add('cardMen'); tagDiv.classList.add('blue'); break;
      case 'Volunteering': card.classList.add('cardVol'); tagDiv.classList.add('orange'); break;
      case 'Donation Drives': card.classList.add('cardDon'); tagDiv.classList.add('red'); break;
      case 'Community Events': card.classList.add('cardCom'); tagDiv.classList.add('purple'); break;
      default: tagDiv.classList.add('blue');
    }

    const h3 = document.createElement('h3'); h3.textContent = data.title || 'Untitled Event';
    const p1 = document.createElement('p');
    const dateKey = data.dateKey || toDateKey(data.date) || '';
    const dateText = formatDateForDisplay(dateKey || data.date || '');
    p1.textContent = (dateText ? dateText : '') + (data.time ? ' | ' + data.time : '');
    p1.appendChild(document.createElement('br'));
    p1.appendChild(document.createTextNode(data.location || ''));

    const p2 = document.createElement('p'); p2.textContent = data.desc || '';
    tagDiv.textContent = data.category || 'Community Events';

    card.appendChild(h3);
    card.appendChild(p1);
    card.appendChild(p2);
    card.appendChild(tagDiv);

    setEventCardData(card, {
      title: data.title,
      date: dateText,
      dateKey,
      time: data.time,
      location: data.location,
      desc: data.desc,
      category: data.category,
      url: data.url || '',
      hotline: data.hotline || '',
      status: data.status || '',
      docId: data.docId || '',
      sourceFirestore: !!data.sourceFirestore
    });
    setupEventCard(card);
    return card;
  }

  function buildResourceCardFromData(data) {
    const card = document.createElement('div');
    card.className = 'card hov';

    const tagDiv = document.createElement('div');
    tagDiv.className = 'tag';

    switch(data.category){
      case 'Mental Health': card.classList.add('cardMen'); tagDiv.classList.add('blue'); break;
      case 'Physical Health': card.classList.add('cardEnv'); tagDiv.classList.add('green'); break;
      case 'Nutrition': card.classList.add('cardVol'); tagDiv.classList.add('orange'); break;
      case 'Wellness': card.classList.add('cardCom'); tagDiv.classList.add('purple'); break;
      case 'Support Groups': card.classList.add('cardDon'); tagDiv.classList.add('red'); break;
      default: tagDiv.classList.add('blue');
    }

    const h3 = document.createElement('h3'); h3.textContent = data.title || 'Untitled Resource';
    const p1 = document.createElement('p'); p1.textContent = data.desc1 || '';
    const p2 = document.createElement('p'); p2.textContent = data.desc2 || '';
    tagDiv.textContent = data.category || 'Wellness';

    card.appendChild(h3);
    card.appendChild(p1);
    card.appendChild(p2);
    card.appendChild(tagDiv);

    setResourceCardData(card, {
      title: data.title,
      desc1: data.desc1,
      desc2: data.desc2,
      category: data.category,
      url: data.url || '',
      hotline: data.hotline || '',
      status: data.status || '',
      docId: data.docId || '',
      sourceFirestore: !!data.sourceFirestore
    });
    card.addEventListener('click', function() {
      openResourceDetail(card);
    });
    return card;
  }

  window.renderEventsFromFirestore = function(list) {
    if (!cards) return;
    // Replace Firestore-backed cards from scratch so removals stay in sync.
    Array.from(cards.querySelectorAll('.card'))
      .filter(card => card.dataset.sourceFirestore === '1')
      .forEach(card => card.remove());

    list.forEach(item => {
      const match = Array.from(cards.querySelectorAll('.card')).find(card => {
        const title = (card.dataset.title || card.querySelector('h3')?.textContent || '').trim().toLowerCase();
        return card.dataset.sourceFirestore !== '1' && title && item.title && title === item.title.trim().toLowerCase();
      });
      if (match) {
        setEventCardData(match, {
          title: item.title,
          date: item.date || '',
          time: item.time || '',
          location: item.location || '',
          desc: item.desc || '',
          category: item.category || 'Community Events',
          url: item.url || '',
          hotline: item.hotline || '',
          status: '',
          docId: item.docId || '',
          sourceFirestore: true
        });
      } else {
        const card = buildEventCardFromData(item);
        cards.appendChild(card);
      }
      removePendingLocalByTitle('pendingEvents', item.title);
    });
    applyEventFilters();
  };

  window.renderResourcesFromFirestore = function(list) {
    if (!resourceCards) return;
    // Replace Firestore-backed cards from scratch so removals stay in sync.
    Array.from(resourceCards.querySelectorAll('.card'))
      .filter(card => card.dataset.sourceFirestore === '1')
      .forEach(card => card.remove());

    list.forEach(item => {
      const match = Array.from(resourceCards.querySelectorAll('.card')).find(card => {
        const title = (card.dataset.title || card.querySelector('h3')?.textContent || '').trim().toLowerCase();
        return card.dataset.sourceFirestore !== '1' && title && item.title && title === item.title.trim().toLowerCase();
      });
      if (match) {
        setResourceCardData(match, {
          title: item.title,
          desc1: item.desc1 || '',
          desc2: item.desc2 || '',
          category: item.category || 'Wellness',
          url: item.url || '',
          hotline: item.hotline || '',
          status: '',
          docId: item.docId || '',
          sourceFirestore: true
        });
      } else {
        const card = buildResourceCardFromData(item);
        resourceCards.appendChild(card);
      }
      removePendingLocalByTitle('pendingResources', item.title);
    });
    applyResourceFilters();
  };

  addBtn && addBtn.addEventListener('click', openModal);
  closeBtn && closeBtn.addEventListener('click', closeModal);
  cancelBtn && cancelBtn.addEventListener('click', closeModal);
  modal && modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });

  closeEventDetailBtn && closeEventDetailBtn.addEventListener('click', closeEventDetailModal);
  eventDetailModal && eventDetailModal.addEventListener('click', function(e){ if(e.target === eventDetailModal) closeEventDetailModal(); });
  closeResourceDetailBtn && closeResourceDetailBtn.addEventListener('click', closeResourceDetailModal);
  resourceDetailModal && resourceDetailModal.addEventListener('click', function(e){ if(e.target === resourceDetailModal) closeResourceDetailModal(); });

  addResourceBtn && addResourceBtn.addEventListener('click', openResourceModal);
  closeResourceBtn && closeResourceBtn.addEventListener('click', closeResourceModal);
  cancelResourceBtn && cancelResourceBtn.addEventListener('click', closeResourceModal);
  resourceModal && resourceModal.addEventListener('click', function(e){ if(e.target === resourceModal) closeResourceModal(); });

  // Update modal style when category changes
  document.getElementById('eventCategory').addEventListener('change', updateEventModalStyle);
  document.getElementById('resourceCategory').addEventListener('change', updateResourceModalStyle);

  form && form.addEventListener('submit', function(e){
    e.preventDefault();
    const title = document.getElementById('eventTitle').value.trim();
    const date = document.getElementById('eventDate').value;
    const dateKey = toDateKey(date);
    const time = document.getElementById('eventTime').value;
    const location = document.getElementById('eventLocation').value.trim();
    const desc = document.getElementById('eventDesc').value.trim();
    const url = normalizeUrl(document.getElementById('eventUrl').value.trim());
    const hotline = document.getElementById('eventHotline').value.trim();
    const category = document.getElementById('eventCategory').value;

    if(!title) return;
    if (!hasActionTarget(url, hotline)) {
      alert('Add either an event URL or hotline number.');
      return;
    }

    if (isEditingEvent && editingEventCard) {
      const tag = editingEventCard.querySelector('.tag');
      const h3 = editingEventCard.querySelector('h3');
      const p1 = editingEventCard.querySelector('p');
      const p2 = editingEventCard.querySelectorAll('p')[1];

      h3.textContent = title;
      const dateText = formatDateForDisplay(dateKey || date);
      p1.textContent = (dateText ? dateText : '') + (time ? ' | ' + time : '');
      p1.appendChild(document.createElement('br'));
      p1.appendChild(document.createTextNode(location));
      p2.textContent = desc;
      tag.textContent = category;

      setEventCardData(editingEventCard, { title, date: dateText || date, dateKey: dateKey || '', time, location, desc, category, url, hotline, status: editingEventCard.dataset.status || '' });
      applyEventFilters();
      closeModal();
      return;
    }

    const card = document.createElement('div');
    card.className = 'card hov';

    const tagDiv = document.createElement('div');
    tagDiv.className = 'tag';

    switch(category){
      case 'Environmental': card.classList.add('cardEnv'); tagDiv.classList.add('green'); break;
      case 'Mental Health': card.classList.add('cardMen'); tagDiv.classList.add('blue'); break;
      case 'Volunteering': card.classList.add('cardVol'); tagDiv.classList.add('orange'); break;
      case 'Donation Drives': card.classList.add('cardDon'); tagDiv.classList.add('red'); break;
      case 'Community Events': card.classList.add('cardCom'); tagDiv.classList.add('purple'); break;
      default: tagDiv.classList.add('blue');
    }

    const h3 = document.createElement('h3'); h3.textContent = title;
    const p1 = document.createElement('p');
    const dateText = formatDateForDisplay(dateKey || date);
    p1.textContent = (dateText ? dateText : '') + (time ? ' | ' + time : '');
    p1.appendChild(document.createElement('br'));
    p1.appendChild(document.createTextNode(location));

    const p2 = document.createElement('p'); p2.textContent = desc;
    tagDiv.textContent = category;

    card.appendChild(h3);
    card.appendChild(p1);
    card.appendChild(p2);
    card.appendChild(tagDiv);

    if (window.createModeratedEvent) {
      window.createModeratedEvent({ title, date: dateKey || date, dateKey: dateKey || '', time, location, desc, category, url, hotline })
        .then((result) => {
          if (!result.approved) {
            alert(`Event was rejected by AI moderation: ${result.reason}`);
            return;
          }
          setEventCardData(card, { title, date: dateText || date, dateKey: dateKey || '', time, location, desc, category, url, hotline, status: '' });
          setupEventCard(card);
          if (cards) cards.insertBefore(card, cards.firstChild);
          applyEventFilters();
          alert(`Event approved: ${result.reason}`);
        })
        .catch(err => {
          console.error('Error during AI event moderation', err);
          alert('Failed to moderate and publish event.');
        })
        .finally(() => {
          closeModal();
        });
    } else {
      closeModal();
    }
  });

  resourceForm && resourceForm.addEventListener('submit', function(e){
    e.preventDefault();
    const title = document.getElementById('resourceTitle').value.trim();
    const desc1 = document.getElementById('resourceDesc1').value.trim();
    const desc2 = document.getElementById('resourceDesc2').value.trim();
    const category = document.getElementById('resourceCategory').value;
    const url = normalizeUrl(document.getElementById('resourceUrl').value.trim());
    const hotline = document.getElementById('resourceHotline').value.trim();

    if(!title) return;
    if (!hasActionTarget(url, hotline)) {
      alert('Add either a resource URL or hotline number.');
      return;
    }

    const card = document.createElement('div');
    card.className = 'card hov';

    const tagDiv = document.createElement('div');
    tagDiv.className = 'tag';

    switch(category){
      case 'Mental Health': card.classList.add('cardMen'); tagDiv.classList.add('blue'); break;
      case 'Physical Health': card.classList.add('cardEnv'); tagDiv.classList.add('green'); break;
      case 'Nutrition': card.classList.add('cardVol'); tagDiv.classList.add('orange'); break;
      case 'Wellness': card.classList.add('cardCom'); tagDiv.classList.add('purple'); break;
      case 'Support Groups': card.classList.add('cardDon'); tagDiv.classList.add('red'); break;
      default: tagDiv.classList.add('blue');
    }

    const h3 = document.createElement('h3'); h3.textContent = title;
    const p1 = document.createElement('p'); p1.textContent = desc1;
    const p2 = document.createElement('p'); p2.textContent = desc2;
    tagDiv.textContent = category;

    card.appendChild(h3);
    card.appendChild(p1);
    card.appendChild(p2);
    card.appendChild(tagDiv);

    if (window.createModeratedResource) {
      window.createModeratedResource({ title, desc1, desc2, category, url, hotline })
        .then((result) => {
          if (!result.approved) {
            alert(`Resource was rejected by AI moderation: ${result.reason}`);
            return;
          }
          setResourceCardData(card, { title, desc1, desc2, category, url, hotline, status: '' });
          if(resourceCards) resourceCards.insertBefore(card, resourceCards.firstChild);
          applyResourceFilters();
          alert(`Resource approved: ${result.reason}`);
        })
        .catch(err => {
          console.error('Error during AI resource moderation', err);
          alert('Failed to moderate and publish resource.');
        })
        .finally(() => {
          closeResourceModal();
        });
    } else {
      closeResourceModal();
    }
  });

  // Filter functionality for Resources
  const resourceFilterBtns = document.querySelectorAll('#health-section .filters button');
  const resourceSearchInput = document.querySelector('#health-section .search-area input[type="text"]');

  if (resourceSearchInput) {
    resourceSearchInput.addEventListener('input', applyResourceFilters);
  }

  resourceFilterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      resourceFilterBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      applyResourceFilters();
    });
  });

  // Filter functionality for Events
  const eventFilterBtns = document.querySelectorAll('#events-section .filters button');
  const eventSearchInput = document.querySelector('#events-section .search-area input[type="text"]');

  if (eventSearchInput) {
    eventSearchInput.addEventListener('input', applyEventFilters);
  }

  eventFilterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      eventFilterBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      applyEventFilters();
    });
  });

  document.querySelectorAll('#events-section .card').forEach(card => {
    const title = card.dataset.title || card.querySelector('h3')?.textContent || '';
    const date = card.dataset.date || '';
    const time = card.dataset.time || '';
    const location = card.dataset.location || '';
    const desc = card.dataset.desc || card.querySelectorAll('p')[1]?.textContent || '';
    const category = card.dataset.category || card.querySelector('.tag')?.textContent || '';
    const url = card.dataset.url || '';
    const hotline = card.dataset.hotline || '';
    setEventCardData(card, { title, date, time, location, desc, category, url, hotline, status: card.dataset.status || '' });
    setupEventCard(card);
  });

  document.querySelectorAll('#health-section .card').forEach(card => {
    const title = card.querySelector('h3')?.textContent || '';
    const desc1 = card.querySelectorAll('p')[0]?.textContent || '';
    const desc2 = card.querySelectorAll('p')[1]?.textContent || '';
    const category = card.querySelector('.tag')?.textContent || '';
    const url = card.dataset.url || '';
    const hotline = card.dataset.hotline || '';
    setResourceCardData(card, { title, desc1, desc2, category, url, hotline });
    card.addEventListener('click', function() {
      openResourceDetail(card);
    });
  });

  // Rehydrate pending items from localStorage
  cleanupPendingLocal('pendingEvents', 1000 * 60 * 60 * 24 * 14);
  cleanupPendingLocal('pendingResources', 1000 * 60 * 60 * 24 * 14);
  const pendingEvents = loadPendingLocal('pendingEvents');
  pendingEvents.forEach(item => {
    const existing = Array.from(cards.querySelectorAll('.card')).some(card => {
      const title = (card.dataset.title || card.querySelector('h3')?.textContent || '').trim().toLowerCase();
      return title && item.title && title === item.title.trim().toLowerCase();
    });
    if (!existing) {
      const card = buildEventCardFromData(item);
      card.classList.add('pending-card');
      cards.insertBefore(card, cards.firstChild);
    }
  });
  applyEventFilters();

  const pendingResources = loadPendingLocal('pendingResources');
  pendingResources.forEach(item => {
    const existing = Array.from(resourceCards.querySelectorAll('.card')).some(card => {
      const title = (card.dataset.title || card.querySelector('h3')?.textContent || '').trim().toLowerCase();
      return title && item.title && title === item.title.trim().toLowerCase();
    });
    if (!existing) {
      const card = buildResourceCardFromData(item);
      card.classList.add('pending-card');
      resourceCards.insertBefore(card, resourceCards.firstChild);
    }
  });
  applyResourceFilters();
});
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, getDocs, onSnapshot, query, where, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBguT9BsQHwsAwAd3mbEmj3S5E7GtR_IBU",
    authDomain: "webmaster-v4-0.firebaseapp.com",
    projectId: "webmaster-v4-0",
    storageBucket: "webmaster-v4-0.firebasestorage.app",
    messagingSenderId: "413556961992",
    appId: "1:413556961992:web:899600895ecb68eb9debfd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.currentUserRole = 'member';

  const MODERATION_API_KEY = "rmSK69XXXz8uoZyNU5kx4m6VrSAoZekS";
  const MODERATION_API_URL = "https://api.mistral.ai/v1/chat/completions";
  const MODERATION_MODEL = "mistral-small-latest";

  function parseModerationResult(text) {
    if (!text) return null;
    const match = text.match(/\{[\s\S]*\}/);
    if (!match) return null;
    try {
      const parsed = JSON.parse(match[0]);
      return {
        approved: !!parsed.approved,
        reason: (parsed.reason || "No reason provided").toString().slice(0, 500),
        risk: (parsed.risk || "unknown").toString().slice(0, 50)
      };
    } catch {
      return null;
    }
  }

  function fallbackModeration(itemType, data) {
    const raw = JSON.stringify(data).toLowerCase();
    const blockedTerms = ["hate", "kill", "violence", "drug", "weapon", "scam", "fraud", "explicit"];
    const hasBlocked = blockedTerms.some(term => raw.includes(term));
    if (hasBlocked) {
      return {
        approved: false,
        reason: `Rejected by fallback moderation for potentially unsafe ${itemType} content.`,
        risk: "high"
      };
    }
    return {
      approved: true,
      reason: `Approved by fallback moderation for ${itemType}.`,
      risk: "low"
    };
  }

  async function moderateWithAI(itemType, data) {
    const prompt = [
      "You are a strict safety moderator for community submissions.",
      `Review this ${itemType} submission and decide if it should be publicly visible.`,
      "Approve only if content is safe and community-appropriate.",
      "Reject content that includes hate, violence, self-harm instructions, sexual explicitness, scams, illegal activity, or dangerous misinformation.",
      "Return JSON only with keys: approved (boolean), reason (string), risk (low|medium|high)."
    ].join(" ");

    const body = {
      model: MODERATION_MODEL,
      temperature: 0,
      messages: [
        { role: "system", content: prompt },
        { role: "user", content: JSON.stringify({ itemType, data }) }
      ],
      response_format: { type: "json_object" }
    };

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 12000);
    let response;
    try {
      response = await fetch(MODERATION_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${MODERATION_API_KEY}`
        },
        body: JSON.stringify(body),
        signal: controller.signal
      });
    } finally {
      clearTimeout(timeout);
    }

    if (!response.ok) {
      throw new Error(`Moderation API failed (${response.status})`);
    }

    const payload = await response.json();
    const text = payload.choices?.[0]?.message?.content || "";
    const result = parseModerationResult(text);
    if (!result) throw new Error("Moderation response parse failed");
    return result;
  }

  async function moderateSubmission(itemType, data) {
    try {
      const result = await moderateWithAI(itemType, data);
      if (result.approved && String(result.risk).toLowerCase() === 'high') {
        return {
          approved: false,
          reason: 'Rejected due to high-risk content signals.',
          risk: 'high'
        };
      }
      return result;
    } catch (err) {
      logFirebaseError('moderation.ai', err, { itemType });
      return fallbackModeration(itemType, data);
    }
  }

  function oneSentenceReason(reason, fallback) {
    const src = (reason || fallback || '').toString().trim();
    if (!src) return fallback || 'Reviewed by moderation.';
    const normalized = src.replace(/\s+/g, ' ').trim();
    const split = normalized.match(/^[^.!?]+[.!?]?/);
    const first = split ? split[0].trim() : normalized;
    return first.endsWith('.') || first.endsWith('!') || first.endsWith('?') ? first : `${first}.`;
  }

  async function createModerationNotification(actor, itemType, title, approved, reason) {
    const shortReason = oneSentenceReason(
      reason,
      approved ? 'Accepted because content appears community-safe.' : 'Denied because content did not meet safety rules.'
    );
    await addDoc(collection(db, 'notifications'), {
      type: 'moderationResult',
      itemType,
      title: approved ? `${itemType === 'event' ? 'Event' : 'Resource'} Accepted` : `${itemType === 'event' ? 'Event' : 'Resource'} Denied`,
      message: `${approved ? 'Accepted' : 'Denied'}: ${shortReason}`,
      status: 'unread',
      createdBy: actor.createdBy,
      createdByEmail: actor.createdByEmail,
      participantId: actor.participantId,
      participantType: actor.participantType,
      createdAt: serverTimestamp()
    });
  }

  function getVisitorId() {
    const key = "rippleVisitorId";
    let id = localStorage.getItem(key);
    if (!id) {
      id = `visitor_${Math.random().toString(36).slice(2, 10)}_${Date.now().toString(36)}`;
      localStorage.setItem(key, id);
    }
    return id;
  }

  async function getPublicIp() {
    const cached = localStorage.getItem('ripplePublicIp');
    if (cached) return cached;
    try {
      const resp = await fetch('https://api.ipify.org?format=json', { cache: 'no-store' });
      const data = await resp.json();
      const ip = data && data.ip ? data.ip : '';
      if (ip) {
        localStorage.setItem('ripplePublicIp', ip);
        return ip;
      }
    } catch (err) {
      console.warn('IP fetch failed:', err.message);
    }
    return '';
  }

  async function resolveParticipantIdentity() {
    if (auth.currentUser) {
      const identity = {
        createdBy: auth.currentUser.uid,
        createdByEmail: auth.currentUser.email || null,
        participantId: `uid:${auth.currentUser.uid}`,
        participantType: 'account',
        uid: auth.currentUser.uid,
        ip: null
      };
      try {
        await setDoc(doc(db, 'participantIdentities', identity.participantId), {
          ...identity,
          updatedAt: serverTimestamp()
        }, { merge: true });
      } catch (err) {
        logFirebaseError('participantIdentity.account', err, { participantId: identity.participantId });
      }
      return identity;
    }

    const visitorId = getVisitorId();
    const ip = await getPublicIp();
    const participantId = ip ? `ip:${ip}` : `visitor:${visitorId}`;
    const identity = {
      createdBy: visitorId,
      createdByEmail: null,
      participantId,
      participantType: ip ? 'ip' : 'visitor',
      uid: null,
      ip: ip || null
    };
    try {
      await setDoc(doc(db, 'participantIdentities', identity.participantId), {
        ...identity,
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      logFirebaseError('participantIdentity.guest', err, { participantId: identity.participantId });
    }
    return identity;
  }

  function saveLocalSignup(key, payload) {
    try {
      const current = JSON.parse(localStorage.getItem(key) || '[]');
      current.unshift({ ...payload, _localTs: Date.now() });
      localStorage.setItem(key, JSON.stringify(current.slice(0, 200)));
    } catch (err) {
      console.warn('Local signup fallback storage failed:', err.message);
    }
  }

  window.createModeratedEvent = async function(eventData) {
    const moderation = await moderateSubmission("event", eventData);
    const actor = await resolveParticipantIdentity();
    const dateKey = toDateKey(eventData.dateKey || eventData.date);
    const status = moderation.approved ? "approved" : "rejected";
    const targetCollection = moderation.approved ? "events" : "rejectedEvents";
    const payload = {
      ...eventData,
      dateKey,
      date: dateKey || eventData.date || '',
      ...actor,
      status,
      moderationReason: moderation.reason,
      moderationRisk: moderation.risk,
      moderatedBy: "ai",
      createdAt: serverTimestamp(),
      moderatedAt: serverTimestamp()
    };
    const ref = await addDoc(collection(db, targetCollection), payload);
    await createModerationNotification(actor, 'event', eventData.title, moderation.approved, moderation.reason);
    return { approved: moderation.approved, reason: moderation.reason, id: ref.id };
  };

  // Helper: create an event signup and notify the user
  window.createEventSignup = async function(eventData) {
    const actor = await resolveParticipantIdentity();
    const dateKey = toDateKey(eventData.dateKey || eventData.date);
    const payload = {
      ...eventData,
      dateKey,
      date: dateKey || eventData.date || '',
      createdBy: actor.createdBy,
      createdByEmail: actor.createdByEmail,
      participantId: actor.participantId,
      participantType: actor.participantType,
      createdAt: serverTimestamp()
    };
    let ref = null;
    try {
      ref = await addDoc(collection(db, 'eventSignups'), payload);
    } catch (err) {
      logFirebaseError('eventSignup.write', err, { participantId: actor.participantId, title: eventData.title });
      saveLocalSignup('rippleLocalEventSignups', {
        ...eventData,
        dateKey: dateKey || '',
        participantId: actor.participantId,
        participantType: actor.participantType
      });
      return { id: `local_${Date.now()}` };
    }
    try {
      await addDoc(collection(db, 'notifications'), {
        type: 'eventSignup',
        itemType: 'event',
        itemId: ref.id,
        title: eventData.title,
        message: `You signed up for ${eventData.title}.`,
        createdBy: actor.createdBy,
        createdByEmail: actor.createdByEmail,
        participantId: actor.participantId,
        participantType: actor.participantType,
        status: 'unread',
        createdAt: serverTimestamp()
      });
    } catch (err) {
      logFirebaseError('eventSignup.notification', err, { participantId: actor.participantId, title: eventData.title });
    }
    return ref;
  };

  // Helper: save a resource for the current user
  window.createResourceSave = async function(resourceData) {
    const actor = await resolveParticipantIdentity();
    const payload = {
      ...resourceData,
      dateKey: new Date().toISOString().slice(0, 10),
      createdBy: actor.createdBy,
      createdByEmail: actor.createdByEmail,
      participantId: actor.participantId,
      participantType: actor.participantType,
      createdAt: serverTimestamp()
    };
    let ref = null;
    try {
      ref = await addDoc(collection(db, 'resourceSaves'), payload);
    } catch (err) {
      logFirebaseError('resourceSave.write', err, { participantId: actor.participantId, title: resourceData.title });
      saveLocalSignup('rippleLocalResourceSaves', {
        ...resourceData,
        dateKey: payload.dateKey,
        participantId: actor.participantId,
        participantType: actor.participantType
      });
      return { id: `local_${Date.now()}` };
    }
    try {
      await addDoc(collection(db, 'notifications'), {
        type: 'resourceSave',
        itemType: 'resource',
        itemId: ref.id,
        title: resourceData.title,
        message: `You saved ${resourceData.title}.`,
        createdBy: actor.createdBy,
        createdByEmail: actor.createdByEmail,
        participantId: actor.participantId,
        participantType: actor.participantType,
        status: 'unread',
        createdAt: serverTimestamp()
      });
    } catch (err) {
      logFirebaseError('resourceSave.notification', err, { participantId: actor.participantId, title: resourceData.title });
    }
    return ref;
  };

  window.createModeratedResource = async function(resourceData) {
    const moderation = await moderateSubmission("resource", resourceData);
    const actor = await resolveParticipantIdentity();
    const status = moderation.approved ? "approved" : "rejected";
    const targetCollection = moderation.approved ? "resources" : "rejectedResources";
    const payload = {
      ...resourceData,
      ...actor,
      status,
      moderationReason: moderation.reason,
      moderationRisk: moderation.risk,
      moderatedBy: "ai",
      createdAt: serverTimestamp(),
      moderatedAt: serverTimestamp()
    };
    const ref = await addDoc(collection(db, targetCollection), payload);
    await createModerationNotification(actor, 'resource', resourceData.title, moderation.approved, moderation.reason);
    return { approved: moderation.approved, reason: moderation.reason, id: ref.id };
  };

  async function notifyResourceRemovedForParticipant(saveData, resourceDocId, resourceTitle) {
    const participantId = saveData.participantId || null;
    const createdBy = saveData.createdBy || null;
    const createdByEmail = saveData.createdByEmail || null;
    const participantType = saveData.participantType || null;
    await addDoc(collection(db, 'notifications'), {
      type: 'resourceRemoved',
      itemType: 'resource',
      title: 'Saved Resource Removed',
      message: 'A resource you saved is no longer available and was removed from your calendar.',
      status: 'unread',
      participantId,
      participantType,
      recipientParticipantId: participantId,
      createdBy,
      createdByEmail,
      resourceDocId: resourceDocId || null,
      resourceTitle: resourceTitle || saveData.title || null,
      createdAt: serverTimestamp()
    });
  }

  async function removeResourceSavesAndNotify(resourceDocId, resourceTitle) {
    const candidates = new Map();

    if (resourceDocId) {
      const byDocId = await getDocs(query(collection(db, 'resourceSaves'), where('resourceDocId', '==', resourceDocId)));
      byDocId.forEach((docSnap) => candidates.set(docSnap.id, docSnap));
    }
    if (resourceTitle) {
      const byTitle = await getDocs(query(collection(db, 'resourceSaves'), where('title', '==', resourceTitle)));
      byTitle.forEach((docSnap) => candidates.set(docSnap.id, docSnap));
    }

    const notified = new Set();
    for (const [id, docSnap] of candidates.entries()) {
      const saveData = docSnap.data() || {};
      await deleteDoc(doc(db, 'resourceSaves', id));
      const notifyKey = saveData.participantId || saveData.createdBy || id;
      if (notified.has(notifyKey)) continue;
      notified.add(notifyKey);
      try {
        await notifyResourceRemovedForParticipant(saveData, resourceDocId, resourceTitle);
      } catch (err) {
        logFirebaseError('resourceRemove.notify', err, { participantId: saveData.participantId || null });
      }
    }
  }

  window.deleteEventByDocId = async function(docId) {
    if (!docId) return;
    await deleteDoc(doc(db, 'events', docId));
  };

  window.deleteResourceByDocId = async function(docId, resourceTitle = '') {
    if (!docId) return;
    await deleteDoc(doc(db, 'resources', docId));
    try {
      await removeResourceSavesAndNotify(docId, resourceTitle || '');
    } catch (err) {
      logFirebaseError('resourceRemove.cascade', err, { resourceDocId: docId, resourceTitle });
    }
  };

  window.signOutUser = function() {
    signOut(auth).then(() => {
      location.reload();
    }).catch((error) => {
      console.error('Sign out error:', error);
    });
  };

  onAuthStateChanged(auth, (user) => {
    const avatar = document.querySelector('.avatar');
    const navRight = document.querySelector('.nav-right');
    if (user) {
      const roleDocRef = doc(db, 'users', user.uid);
      getDoc(roleDocRef).then((snap) => {
        if (snap.exists() && snap.data().role) {
          window.currentUserRole = snap.data().role;
        }
      }).catch(() => {
        window.currentUserRole = 'member';
      });
      // User is signed in
      const initial = (user.email || '').charAt(0).toUpperCase();
      if (avatar) {
        if (user.photoURL) {
          avatar.style.backgroundImage = `url('${user.photoURL}')`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.textContent = '';
        } else {
          avatar.style.backgroundImage = '';
          avatar.textContent = initial;
        }
        avatar.style.cursor = 'pointer';
        avatar.onclick = () => window.location.href = 'account.html';
      }
      // Remove sign in button if exists
      const signInBtn = document.querySelector('.sign-in-btn');
      if (signInBtn) {
        signInBtn.remove();
      }
    } else {
      // User is signed out
      if (avatar) {
        avatar.textContent = ''; // or default
      }
      // Remove sign out button if exists
      const signOutBtn = document.querySelector('.sign-out-btn');
      if (signOutBtn) {
        signOutBtn.remove();
      }
      // Add sign in button
      if (navRight && !document.querySelector('.sign-in-btn')) {
        const signInBtn = document.createElement('button');
        signInBtn.textContent = 'Sign In';
        signInBtn.className = 'sign-in-btn';
        signInBtn.style.padding = '8px 16px';
        signInBtn.style.background = 'linear-gradient(to bottom, #4c7dff, #2e63e5)';
        signInBtn.style.color = 'white';
        signInBtn.style.border = 'none';
        signInBtn.style.borderRadius = '999px';
        signInBtn.style.cursor = 'pointer';
        signInBtn.style.fontSize = '14px';
        signInBtn.style.fontWeight = '600';
        signInBtn.style.boxShadow = '0 4px 12px rgba(76, 125, 255, 0.25)';
        signInBtn.style.transition = 'transform 0.1s ease, box-shadow 0.1s ease';
        signInBtn.onclick = () => window.location.href = 'login.html';
        signInBtn.onmouseover = () => {
          signInBtn.style.transform = 'translateY(-1px)';
          signInBtn.style.boxShadow = '0 6px 16px rgba(76, 125, 255, 0.35)';
        };
        signInBtn.onmouseout = () => {
          signInBtn.style.transform = 'translateY(0)';
          signInBtn.style.boxShadow = '0 4px 12px rgba(76, 125, 255, 0.25)';
        };
        navRight.appendChild(signInBtn);
      }
    }
  });

  // Load approved events/resources from Firestore if available
  const eventsQuery = query(collection(db, 'events'));
  onSnapshot(eventsQuery, (snapshot) => {
    const list = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      list.push({
        docId: docSnap.id,
        sourceFirestore: true,
        title: data.title,
        date: formatDateForDisplay(data.dateKey || data.date || data.dateText || ''),
        dateKey: data.dateKey || toDateKey(data.date || data.dateText || ''),
        time: data.time || '',
        location: data.location || '',
        desc: data.desc || data.description || '',
        category: data.category || 'Community Events',
        url: data.url || '',
        hotline: data.hotline || ''
      });
    });
    if (window.renderEventsFromFirestore) {
      window.renderEventsFromFirestore(list);
    }
  }, () => {});

  const resourcesQuery = query(collection(db, 'resources'));
  onSnapshot(resourcesQuery, (snapshot) => {
    const list = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      list.push({
        docId: docSnap.id,
        sourceFirestore: true,
        title: data.title,
        desc1: data.desc1 || data.description || '',
        desc2: data.desc2 || '',
        category: data.category || 'Wellness',
        url: data.url || '',
        hotline: data.hotline || ''
      });
    });
    if (window.renderResourcesFromFirestore) {
      window.renderResourcesFromFirestore(list);
    }
  }, () => {});
</script>
<script src="bubbles.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const footerPlaceholder = document.getElementById('footer-placeholder');
    if (footerPlaceholder) {
      fetch('footer.html')
        .then(response => response.text())
        .then(html => {
          footerPlaceholder.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading footer:', error);
        });
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const headerPlaceholder = document.getElementById('header-placeholder');
    if (!headerPlaceholder) return;

    fetch('header.html')
      .then(response => response.text())
      .then(html => {
        headerPlaceholder.innerHTML = html;

        // 1) Set active link for this page automatically
        const path = window.location.pathname.split('/').pop(); // gets "main.html"
        const links = headerPlaceholder.querySelectorAll('.nav-link');
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (href === path) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });

        // 2) Wire up hamburger menu
        const hamburger = headerPlaceholder.querySelector('.hamburger');
        const navLinks = headerPlaceholder.querySelector('.nav-links');

        if (hamburger && navLinks) {
          hamburger.addEventListener('click', function (event) {
            event.stopPropagation();
            navLinks.classList.toggle('open');
          });

          document.addEventListener('click', function (event) {
            if (!navLinks.contains(event.target) && !hamburger.contains(event.target)) {
              navLinks.classList.remove('open');
            }
          });

          const navLinkElements = headerPlaceholder.querySelectorAll('.nav-link');
          navLinkElements.forEach(link => {
            link.addEventListener('click', function () {
              navLinks.classList.remove('open');
            });
          });
        }
      })
      .catch(error => {
        console.error('Error loading header:', error);
      });
  });
</script>
<script src="bubble-transition.js"></script>
</body>
</html>
